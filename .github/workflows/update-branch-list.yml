name: Update Branch List

on:
  create:
  delete:
  workflow_dispatch:

jobs:
  update-branch-inputs:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.ref_type == 'branch'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          ref: ${{ github.event.repository.default_branch }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate and update workflow
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Get all branches, excluding main, dev, HEAD references
          branches=$(gh api repos/${{ github.repository }}/branches --paginate -q '.[].name' | grep -vE '^(main|master|dev|HEAD)$' | sort)

          echo "Found branches:"
          echo "$branches"

          # Export for Python
          export BRANCHES="$branches"

          # Write Python script to temp file to avoid YAML parsing issues
          cat > /tmp/generate_workflow.py << 'PYSCRIPT'
          import os
          import re

          DOLLAR_BRACE = "DLRBRC"
          CLOSE_BRACE = "CLSBRC"
          BASH_OPEN = "BASHOPEN"
          BASH_CLOSE = "BASHCLOSE"

          def gha(expr):
              return f"{DOLLAR_BRACE}{expr}{CLOSE_BRACE}"

          def bash_expr(expr):
              return f"{BASH_OPEN}{expr}{BASH_CLOSE}"

          branches_str = os.environ.get('BRANCHES', '')
          branches = [b.strip() for b in branches_str.split('\n') if b.strip()]

          inputs_lines = []
          inputs_lines.append("      reset_dev:")
          inputs_lines.append("        description: 'Reset dev to main before merging (destroys existing dev)'")
          inputs_lines.append("        type: boolean")
          inputs_lines.append("        default: false")
          inputs_lines.append("      sync_upstream:")
          inputs_lines.append("        description: 'Sync with upstream before merging (pulls latest from Mirrowel/LLM-API-Key-Proxy)'")
          inputs_lines.append("        type: boolean")
          inputs_lines.append("        default: false")
          inputs_lines.append("      upstream_branch:")
          inputs_lines.append("        description: 'Upstream branch to sync from'")
          inputs_lines.append("        type: string")
          inputs_lines.append("        default: 'dev'")
          for branch in branches:
              input_name = re.sub(r'[^a-zA-Z0-9]', '_', branch)
              inputs_lines.append(f"      branch_{input_name}:")
              inputs_lines.append(f"        description: '{branch}'")
              inputs_lines.append(f"        type: boolean")
              inputs_lines.append(f"        default: false")

          inputs_lines.append("      custom_branches:")
          inputs_lines.append("        description: 'Additional branches (comma-separated, optional)'")
          inputs_lines.append("        type: string")
          inputs_lines.append("        required: false")

          inputs_yaml = '\n'.join(inputs_lines)

          workflow = f"""name: AI Multi-Branch Merge
          run-name: Merging branches into dev by @{gha(" github.actor ")}

          on:
            workflow_dispatch:
              inputs:
          {inputs_yaml}

          concurrency:
            group: ai-merge-dev
            cancel-in-progress: false

          jobs:
            merge-branches:
              runs-on: ubuntu-latest
              permissions:
                contents: write

              steps:
                - name: Checkout repository
                  uses: actions/checkout@v4
                  with:
                    fetch-depth: 0
                    token: {gha(" secrets.GH_PAT ")}

                - name: Configure Git
                  run: |
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"

                - name: Install Opencode
                  run: curl -fsSL https://opencode.ai/install | bash

                - name: Configure Opencode for LLM Proxy
                  env:
                    LLM_PROXY_URL: {gha(" secrets.LLM_PROXY_URL ")}
                    LLM_PROXY_API_KEY: {gha(" secrets.LLM_PROXY_API_KEY ")}
                    LLM_PROXY_MODEL: {gha(" secrets.LLM_PROXY_MODEL ")}
                  run: |
                    mkdir -p ~/.config/opencode
                    DOLLAR='$'
                    MODEL="{bash_expr('LLM_PROXY_MODEL:-nano_gpt/zai-org/glm-4.7')}"
                    cat > ~/.config/opencode/opencode.json <<EOFCFG
                    {{
                      "{bash_expr('DOLLAR')}schema": "https://opencode.ai/config.json",
                      "provider": {{
                        "llm-proxy": {{
                          "api": "openai",
                          "models": {{ "$MODEL": {{}} }},
                          "options": {{ "apiKey": "$LLM_PROXY_API_KEY", "baseURL": "$LLM_PROXY_URL" }}
                        }}
                      }},
                      "model": "llm-proxy/$MODEL"
                    }}
                    EOFCFG

                - name: Collect selected branches
                  id: collect
                  env:
                    INPUTS_JSON: {gha(" toJSON(github.event.inputs) ")}
                    SYNC_UPSTREAM: {gha(" github.event.inputs.sync_upstream ")}
                  run: |
                    echo "Processing inputs..."
                    branches=""
                    selected=$(echo "$INPUTS_JSON" | jq -r 'to_entries | .[] | select(.key | startswith("branch_")) | select(.value == "true") | .key')
                    for input_name in $selected; do
                      branch_name=$(grep -A1 "^      $input_name:" .github/workflows/ai-merge-dev.yml | grep "description:" | sed "s/.*description: '\\\\(.*\\\\)'/\\\\1/")
                      if [ -n "$branch_name" ]; then branches="{bash_expr('branches:+$branches, ')}$branch_name"; fi
                    done
                    custom="{gha(" github.event.inputs.custom_branches ")}"
                    if [ -n "$custom" ]; then branches="{bash_expr('branches:+$branches, ')}$custom"; fi
                    echo "Selected branches: $branches"
                    echo "branches=$branches" >> $GITHUB_OUTPUT
                    echo "has_branches=$( [ -n \\"$branches\\" ] && echo true || echo false )" >> $GITHUB_OUTPUT
                    if [ -z "$branches" ] && [ "$SYNC_UPSTREAM" != "true" ]; then
                      echo "::error::No branches selected and upstream sync not enabled"
                      exit 1
                    fi

                - name: Prepare Dev Branch
                  env:
                    RESET_DEV: {gha(" github.event.inputs.reset_dev ")}
                  run: |
                    echo "## AI Multi-Branch Merge" >> $GITHUB_STEP_SUMMARY
                    git fetch origin main:main
                    if git ls-remote --heads origin dev | grep -q dev; then
                      git checkout dev
                      git pull origin dev
                      if [ "$RESET_DEV" = "true" ]; then
                        git reset --hard origin/main
                        echo ":warning: Reset 'dev' to 'main'." >> $GITHUB_STEP_SUMMARY
                      else
                        echo "Continuing from existing 'dev' branch." >> $GITHUB_STEP_SUMMARY
                      fi
                    else
                      git checkout -b dev origin/main
                      echo "Created 'dev' from 'main'." >> $GITHUB_STEP_SUMMARY
                    fi

                - name: Sync with Upstream
                  if: {gha(" github.event.inputs.sync_upstream == 'true' ")}
                  env:
                    UPSTREAM_BRANCH: {gha(" github.event.inputs.upstream_branch ")}
                  run: |
                    echo "### Upstream Sync" >> $GITHUB_STEP_SUMMARY
                    git remote add upstream https://github.com/Mirrowel/LLM-API-Key-Proxy.git 2>/dev/null || true
                    git fetch upstream "$UPSTREAM_BRANCH"
                    echo "Merging upstream/$UPSTREAM_BRANCH..."
                    if git merge "upstream/$UPSTREAM_BRANCH" --no-commit --no-ff; then
                      if git diff --cached --quiet; then
                        echo "Already up to date with upstream/$UPSTREAM_BRANCH." >> $GITHUB_STEP_SUMMARY
                      else
                        git commit -m "chore(dev): sync with upstream/$UPSTREAM_BRANCH"
                        echo ":arrows_counterclockwise: Synced with upstream/$UPSTREAM_BRANCH (clean merge)." >> $GITHUB_STEP_SUMMARY
                      fi
                    else
                      echo "Conflicts with upstream - invoking Opencode..."
                      for file in $(git diff --name-only --diff-filter=U); do
                        echo "Resolving $file..."
                        printf "Resolve merge conflict in %s. Read the file, analyze conflict markers, resolve logically, and save. Ensure no markers remain." "$file" > /tmp/prompt.txt
                        opencode run --share - < /tmp/prompt.txt || {{ git merge --abort; echo ":x: Failed to sync with upstream (AI error)." >> $GITHUB_STEP_SUMMARY; exit 1; }}
                        grep -qE '^(<<<<<<<|=======|>>>>>>>)' "$file" && {{ git merge --abort; echo ":x: Failed to sync with upstream (markers remain)." >> $GITHUB_STEP_SUMMARY; exit 1; }}
                        git add "$file"
                      done
                      git commit -m "chore(dev): sync with upstream/$UPSTREAM_BRANCH (AI resolved)"
                      echo ":robot: Synced with upstream/$UPSTREAM_BRANCH (AI resolved conflicts)." >> $GITHUB_STEP_SUMMARY
                    fi

                - name: Merge Branches
                  if: {gha(" steps.collect.outputs.has_branches == 'true' ")}
                  env:
                    BRANCHES_INPUT: {gha(" steps.collect.outputs.branches ")}
                  run: |
                    echo "### Merge Results" >> $GITHUB_STEP_SUMMARY
                    echo "| Branch | Status | Notes |" >> $GITHUB_STEP_SUMMARY
                    echo "|--------|--------|-------|" >> $GITHUB_STEP_SUMMARY
                    IFS=',' read -ra BRANCHES <<< "$BRANCHES_INPUT"
                    for branch in "{bash_expr('BRANCHES[@]')}"; do
                      branch=$(echo "$branch" | xargs)
                      echo "::group::Merging $branch"
                      git fetch origin "$branch" 2>/dev/null || {{ echo "| $branch | :x: Not Found | - |" >> $GITHUB_STEP_SUMMARY; echo "::endgroup::"; continue; }}
                      if git merge "origin/$branch" --no-commit --no-ff; then
                        if git diff --cached --quiet; then
                          echo "| $branch | :white_check_mark: Already merged | - |" >> $GITHUB_STEP_SUMMARY
                        else
                          git commit -m "chore(dev): merge branch '$branch'"
                          echo "| $branch | :white_check_mark: Clean | - |" >> $GITHUB_STEP_SUMMARY
                        fi
                      else
                        echo "Conflicts in $branch - invoking Opencode..."
                        for file in $(git diff --name-only --diff-filter=U); do
                          echo "Resolving $file..."
                          printf "Resolve merge conflict in %s. Read the file, analyze conflict markers, resolve logically, and save. Ensure no markers remain." "$file" > /tmp/prompt.txt
                          opencode run --share - < /tmp/prompt.txt || {{ git merge --abort; echo "| $branch | :x: Failed | Opencode error |" >> $GITHUB_STEP_SUMMARY; echo "::endgroup::"; continue 2; }}
                          grep -qE '^(<<<<<<<|=======|>>>>>>>)' "$file" && {{ git merge --abort; echo "| $branch | :x: Failed | Markers remain |" >> $GITHUB_STEP_SUMMARY; echo "::endgroup::"; continue 2; }}
                          git add "$file"
                        done
                        git commit -m "chore(dev): merge '$branch' with AI resolution"
                        echo "| $branch | :robot: AI Resolved | - |" >> $GITHUB_STEP_SUMMARY
                      fi
                      echo "::endgroup::"
                    done

                - name: Push Dev Branch
                  run: |
                    git push origin dev --force
                    echo ":rocket: Pushed 'dev' branch." >> $GITHUB_STEP_SUMMARY
          """

          # Remove leading indentation
          lines = workflow.split('\\n')
          min_indent = min((len(l) - len(l.lstrip()) for l in lines if l.strip()), default=0)
          cleaned = '\\n'.join(l[min_indent:] if l.strip() else '' for l in lines)

          with open('.github/workflows/ai-merge-dev.yml', 'w') as f:
              f.write(cleaned)
          print("Generated workflow file")
          PYSCRIPT

          python3 /tmp/generate_workflow.py

          # Replace placeholders with actual syntax using octal escape codes
          # Octal: dollar=044, open-brace=173, close-brace=175
          GHA_OPEN=$(printf '\044\173\173 ')
          GHA_CLOSE=$(printf ' \175\175')
          BASH_DOLLAR=$(printf '\044\173')
          BASH_CLOSE=$(printf '\175')
          sed -i "s#DLRBRC#${GHA_OPEN}#g" .github/workflows/ai-merge-dev.yml
          sed -i "s#CLSBRC#${GHA_CLOSE}#g" .github/workflows/ai-merge-dev.yml
          sed -i "s#BASHOPEN#${BASH_DOLLAR}#g" .github/workflows/ai-merge-dev.yml
          sed -i "s#BASHCLOSE#${BASH_CLOSE}#g" .github/workflows/ai-merge-dev.yml

          echo "Updated workflow file:"
          head -30 .github/workflows/ai-merge-dev.yml

      - name: Commit and push changes
        run: |
          if git diff --quiet .github/workflows/ai-merge-dev.yml; then
            echo "No changes to commit"
            exit 0
          fi

          git add .github/workflows/ai-merge-dev.yml
          git commit -m "chore(ci): auto-update branch list for AI merge workflow"
          git push
